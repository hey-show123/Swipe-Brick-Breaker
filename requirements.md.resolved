# ピンボール（Swipe Brick Breaker）ゲーム 要件定義書

## 1. プロジェクト概要
**タイトル**: Pinball Breaker (仮)
**ジャンル**: スワイプ・ブロック崩し (Swipe Brick Breaker / Ballz Clone)
**プラットフォーム**: Webブラウザ (Mobile First / Responsive)
**技術スタック**: React, TypeScript, Canvas API

## 2. コア・ゲームプレイループ
このゲームはターン制のアクションパズルゲームです。
1.  **Aiming (エイムフェーズ)**: プレイヤーは発射方向を決定する。
2.  **Shooting (発射フェーズ)**: 多数のボールが連続して発射される。
3.  **Physics (物理演算フェーズ)**: ボールは重力の影響を受けず、壁やブロックに反射してダメージを与える。
4.  **Returning (帰還フェーズ)**: 全てのボールが画面下部に落下・回収されるまで待つ。
5.  **Turn End (ターン終了)**: 
    *   ブロックが1段下がる。
    *   最下段に新しいブロックの列が生成される。
    *   ボールの総数が増える（アイテム取得時など）。
    *   最初に戻ってきたボールの位置が、次ターンの発射位置となる。

## 3. 機能要件

### 3.1 プレイヤーアクション
*   **ドラッグ操作**: 画面をドラッグして発射角度を調整する（引っ張りアクション、または指の方向への発射）。
*   **予測線 (Aiming Line)**: 発射前にボールの軌道（壁の反射を含む）を点線で表示する。
*   **発射**: 指を離すとボールが発射される。
*   **早送り/スキップ (オプション)**: ボールの移動が長引いた場合に高速化する機能。

### 3.2 ゲームエンティティ
*   **ボール (Ball)**
    *   サイズ: 一定（例: 半径8px）。
    *   速度: 一定速度で移動（減衰なし）。
    *   特性: 完全弾性衝突。壁・ブロックで跳ね返る。
*   **ブロック (Block)**
    *   形状: 正方形、三角形（4方向）。
    *   体力 (HP): ボールが当たるたびに1減る。0になると消滅。
    *   表示: HPの数値を中心に表示（三角形の場合は重心位置）。残りHPに応じて色が変化（グラデーション）。
*   **アイテム (Item)**
    *   **+1ボール**: 取得すると、次ターンからボールの総数が1増える。緑色のリングなどで表現。
    *   **コイン (オプション)**: スコアやショップ用の通貨。

### 3.3 ゲームルール
*   **ゲームオーバー**: ブロックが「デッドライン（発射ライン）」に到達した時点で終了。
*   **スコア**: ブロックを破壊した数、またはターン数に基づく。
*   **レベルデザイン**:
    *   ターン経過とともにブロックのHPが増加する。
    *   ブロックの配置はランダム、またはパターンから生成。

### 3.4 物理・挙動
*   **衝突判定 (Collision)**:
    *   円(ボール) vs AABB(矩形ブロック)。
    *   円(ボール) vs 線分/多角形(三角形ブロック)。
*   **めり込み防止**: 高速移動時の突き抜け（Tunneling）を防ぐ、またはめり込んだ場合の位置補正処理。
*   **無限ループ防止**: ボールが水平に跳ね続ける場合などに、強制的に下方向へ重力をかけるか角度を変える仕組み。

### 3.5 UI/UX
*   **現在のボール数**: `x 35` のように現在のボール数と待機数を表示。
*   **スコア表示**: 現在のスコアとハイスコア。
*   **演出**:
    *   ブロックヒット時のパーティクル・振動（Screen Shake）。
    *   ブロック破壊時の派手なエフェクト。
    *   ボール回収時の吸い込みアニメーション。

## 4. 技術的課題と解決方針
現在の実装で見受けられる「根本的な問題」に対する解決策：

*   **状態管理の分離**: ReactのState更新サイクルと、Canvasの60fpsループ(requestAnimationFrame)を明確に分離する。アニメーションループ内ではReactの`setState`を極力呼ばない（再レンダリング負荷回避）。
*   **物理エンジンの堅牢化**: 
    *   自作の簡易物理計算では「角に当たった時の挙動」や「すり抜け」が起きやすい。
    *   より堅牢なカスタム衝突判定、または軽量な2D物理ライブラリ（Matter.js等は重すぎる可能性があるため、専用の軽量実装を推奨）を整備する。
*   **発射ロジックの安定化**: `setInterval`ではなく、メインループ内でフレーム経過による発射管理を行うことで、ブラウザのタブ切り替え時などの挙動不整合を防ぐ。

## 5. UIデザイン要件
*   **テーマ**: ネオン、ダークモード、モダンでリッチな質感。
*   **レスポンシブ**: スマートフォン（縦画面）を基準としつつ、PCでも中央表示で崩れないレイアウト。
